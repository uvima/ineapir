---
title: "Usage examples"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Example 1. Time series

```{r example_1}
library(ineapir)
library(ggplot2)

# Filter cpi overall index
filter <- list(values = c("variación anual" , "índice general"))

# Request data of cpi
# Table url: https://www.ine.es/jaxiT3/Tabla.htm?t=50902&L=0
general <- get_data_table(idTable = 50902, filter = filter, unnest = TRUE,
                          tip = "A" )

# Filter core cpi
filter <- list(values = c("variación anual" , 
                       "general sin alimentos no elaborados ni productos energéticos"))

# Request data of core cpi
# Table url: https://www.ine.es/jaxiT3/Tabla.htm?t=50907&L=0
subyacente <- get_data_table(idTable = 50907, filter = filter, unnest = TRUE,
                             tip = "A" )

# Format Fecha column as date
general$Fecha <- as.Date(general$Fecha)
subyacente$Fecha <- as.Date(subyacente$Fecha)

# Plot both time series
ggplot(data = general, aes(Fecha, Valor)) +
  geom_line(aes(colour = 'General')) +
  geom_line(data= subyacente, aes(colour = 'Subyacente')) +
  labs(y = 'Variación anual (%)', colour = 'IPC') +
  theme(legend.position = "bottom")

```

## Example 2. Population pyramid

```{r example_2}
library(dplyr, quietly = TRUE)
library(forcats)

# Filter for total population of men and women 
filter <- list(nacionalidad = "total", sexo = c("hombres", "mujeres"))

# Table: Resident population by date, sex, age group and nationality
# Table url: https://www.ine.es/jaxiT3/Tabla.htm?t=9674&L=0
poblacion <- get_data_table(idTable = 9674, filter = filter, validate = FALSE, 
                            tip = "AM", unnest = TRUE, extractmetadata = TRUE)

# Filter totals and calculate percentages
poblacion %>% 
  filter(Edad != "Total" & T3_Periodo == "1 de enero de" & Anyo == 2022) %>%
  mutate(Total = sum(Valor), 
         Porcentaje = Valor/Total*100, 
         Edad = fct_inorder(Edad)) %>%
  mutate(Porcentaje = ifelse(Sexo == "Hombres",
                             -Porcentaje, Porcentaje)) %>%
# Plot the pyramid
  ggplot(aes(x = Edad, y = Porcentaje ,fill = Sexo)) +
    geom_col(position = "stack", alpha = 0.8) +
    coord_flip() + theme(legend.position = "bottom", 
                         plot.title = element_text(hjust = 0.5)) +
    scale_y_continuous(labels = abs) +
    labs(title = 'Población residente por sexo y grupo de edad (2022)')

```

## Example 3. Animate polulation pyramids
```{r example_3}
library(gganimate)

# Filter totals and calculate percentages
poblacion %>% 
  filter(Edad != "Total" & T3_Periodo == "1 de enero de") %>%
  group_by(Anyo) %>% 
  mutate(Total = sum(Valor), 
         Porcentaje = Valor/Total*100, 
         Edad = fct_inorder(Edad)) %>% ungroup() %>%
  mutate(Porcentaje = ifelse(Sexo == "Hombres",
                             -Porcentaje, Porcentaje)) %>%
# Plot the pyramid
ggplot(aes(x = Edad, y = Porcentaje ,fill = Sexo)) +
  geom_col(position = "stack", alpha = 0.8) +
  coord_flip() + theme(legend.position = "bottom",
                       plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(labels = abs) + transition_time(Anyo) + 
  labs(title = 'Población residente por sexo y grupo de edad (Año: {as.integer(frame_time)})')

```


## Example 4. Interactive bar chart.
```{r example_4}
library(plotly)

# Filter for unemployment rates
filter = list(ccaa = "", sexo = "ambos", edad = "total")

# Table: Unemployment rates by different age groups, sex and Autonomous Community
# Table url: https://www.ine.es/jaxiT3/Tabla.htm?t=4247&L=0
paro <- get_data_table(idTable = 4247, filter = filter, nlast = 1, inecode = TRUE,
                       unnest = TRUE, extractmetadata = TRUE, tip = "AM")

# Bar chart using plotly library
fig <- plot_ly(paro, 
               x = ~paro$`Comunidades y Ciudades Autónomas`,
               y = ~Valor, type = "bar") %>%
       config(displayModeBar = FALSE) %>%
       layout(xaxis = list(title="", tickangle = -45),
              yaxis = list(title = "Tasa de paro (%)"),
              title = sprintf("Tasa de paro por Comunidad Autónoma (%s %s)",
                              paro$T3_Periodo[1], paro$Anyo[1])
              )

fig
  
```

## Example 5. Interactive time series.
```{r example_5}
# we reuse the data from example 1.
# cpi overall index
fig <- plot_ly(general, x = ~Fecha, y = ~Valor, name = 'General',
               type = 'scatter', mode = 'lines')

# Core cpi
fig <- fig %>% add_trace(y = ~subyacente$Valor, name = 'Subyacente',
                         mode = 'lines') %>%
  layout(yaxis = list(title="Variación anual (%)"),
         legend = list(title=list(text='<b> IPC </b>'),
                       x = 0.25,
                       y = -0.25,
                       orientation = 'h'),
         hovermode = 'x') %>%
  config(displayModeBar = FALSE)
  
                       

fig

```

